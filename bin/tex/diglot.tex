\newcount\diglotTRcount%
%\def\TRshipout#1{\shipout#1}
\def\TRshipout#1{}
\def\b@xbotmark{}
\def\TRACEdiglot#1{\global\advance\diglotTRcount by 1 \MSG{\the\diglotTRcount: #1}}%
\newif\ifdiglot %If there is diglot material
\diglotfalse%
\newif\ifdiglotSepNotes %If the footnotes from the versions should be split (true) or merged together
\diglotSepNotestrue%
\newif\ifdiglotBalNotes %If a left column footnote steals space from the right column also
\diglotBalNotesfalse%
\global\def\n@xtc@mmand{}%

%\partial % Partial page (both columns)
\newbox\partialL \setbox\partialL=\vbox{} % Partial page, on the left side
\newbox\excessL \setbox\excessL=\vbox{} % Excess left material, once we know we're on the next page (added to partialL on shipout)
\newbox\partialR \setbox\partialR=\vbox{} % Partial page on the right side

%\newbox\partialPage \setbox\partialPage=\vbox{}
%\diglotLeft={\hsize=\columnLwidth\global\setbox\partialL=\vbox{\unvbox\partialL\unvbox255}}

\newif\ifrunLtrial % logic test in diglotLeft

\def\calc@vailht{
   \ifdiglotL
	 \TRACEdiglot{calc@vailht L}
   \else
	 \TRACEdiglot{calc@vailht R}
   \fi
   \global\availht=\textheight %
   \let\\=\reduceavailht \the\n@tecl@sses % reduce it by the space needed for each note class
   \decr{\availht}{\topins} %pictures
   \decr{\availht}{\bottomins}%
   \global\advance\availht by -\ht\partial %
   \global\advance\availht by -\dp\partial %
   \ifdiglotL
	 \global\availhtL=\availht
   \else
	 \global\availhtR=\availht
   \fi
   \TRACEdiglot{...\the\availht}
}
\newif\ifnastybox  % Signal that box must be treated specially
\newif\ifrepeatok  % Signal that an unusual calling sequence has happend
\newif\ifearlyLrefill % In some circumstances partialL is empty deliberatly, other times it isn't
\repeatoktrue

\newcount\thisboxpenalty
% Initial \output routine for left scripture
\def\diglotLeft{%
 %This gets called every time that there's something the computer thinks
 %fills the rest of the page with text - maybe multiple times - and also on
 %a column switch.
 % It should put the text into different boxes, depending on how much text
 % we have relative to the space available. It should also re-run the text
 % through TeX  to apply footnotes, but ONLY those portions of text that will
 % really fit on this page.
 % assumes: \availht is correct, \ifleftfull set false on page output
 % Fills: \partialL, \excessL
 % Empties: \box255
 \TRACEdiglot{diglotLeft O:\the\outputpenalty P:\the\savedpenalty, LP:\the\lastsavedLpenalty, vs:\the\vsize, pg:\the\pagegoal, pt:\the\pagetotal, bs:\the\baselineskip}%
 \runLtrialfalse%
 \makevtop{255}%
 \thisboxpenalty=\outputpenalty
 \ifnum\outputpenalty=10000% Nothing wrong with breaking here
   \thisboxpenalty=0\relax%
 \else%
   \ifnum\outputpenalty=-10001%Got to the end of the \lefttext
	 \thisboxpenalty=\savedpenalty\relax
   \fi%
 \fi%
 \ifleftfull%
   \TRACEdiglot{adding extra (\the\ht255+\the\dp255) mtl to excessL (\the\ht\excessL+\the\dp\excessL)}
   %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeft -> excessL:}\copy255}}
   \global\setbox\excessL=\vtop{\joinboxes{\excessL}{255}{1}}%
   %\shipout\copy\excessL
   %\showbox\excessL
   \global\vsize=\textheight
   %Text in partialL has already be re-processed.
 \else%
   \TRACEdiglot{adding mtl (\the\ht255+\the\dp255) to partialL pl:\the\ht\partialL, av:\the\availht}%
   %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeft -> partialL:}\copy255}}%
   \global\setbox\partialL=\vtop{\joinboxes{\partialL}{255}{2}}%
   \TRACEdiglot{pL: (\the\ht\partialL+\the\dp\partialL), av:\the\availht, p:(\the\ht\partial+\the\dp\partial), vs:\the\vsize}%
   \global\nastyboxfalse
   \bgroup%
   \ifnum\thisboxpenalty=10000 %This place must not be the last on the page. How nasty is that?
	 \TRACEdiglot{Checking what to do with this box}
	 %{\showboxbreadth=13\nonstopmode\showbox\partialL}
	 \dimen0=\availht %
	 \dimen1=0pt % Use ifnastybox as a flag that the box should be split to dimen1, unless it stays 0pt in which case pass it on to the next page
	 \advance\dimen0 by -\ht\partialL %
	 \advance\dimen0 by -\dp\partialL %
	 \ifdim\dimen0>-0.3\baselineskip % The box fits..
		\dimen1=\availht%Default: put it on the page
		\ifdim\dimen0<2\baselineskip %
	  \global\nastyboxtrue %only just fits. Very nasty - no space for even another line after this one.
	  \ifdim\dp\partialL>3\baselineskip
		%this box is of reasonable size, just split it earlier
		\dimen1=\ht\partialL
		\advance\dimen1 by \dp\partialL
		\advance\dimen1 by -1\baselineskip
	  \else
		%It is small. Probably a heading, best to promote it
		\dimen1=0pt
			\ifnum\lastsavedLpenalty=10000
		  %But on the other hand we can't put it on the next page
		  %so try splitting it after all
		  \dimen1=\ht\partialL
		  \advance\dimen1 by \dp\partialL
		  \advance\dimen1 by -1\baselineskip
		\fi
	  \fi
	\fi%
	 \else % Box is too big to fit
	\ifdim\dp\partialL>3\baselineskip
	  %this box is of reasonable size, just split it
	  \dimen1=\availht
	\else
	  %It is small. Probably a heading, best to promote it
	  \global\nastyboxtrue
	  \dimen1=0pt
	\fi
	 \fi
   \fi
   \ifdim \dimen1<0pt
	 \dimen1=0pt
	 \global\leftfulltrue
   \fi
   \ifnastybox%
	 \TRACEdiglot{Nasty box \the\ht\partialL+\the\dp\partialL, resizing to \the\dimen1, somewhere near \the\inputlineno, \botmark}
   \else
	 \dimen0=\availht
	 \advance\dimen0 by -\ht\partialL
	 \advance\dimen0 by -\dp\partialL
	 \dimen1=\availht %Cutting length...
	 \ifdim \dimen1<0pt
	   \dimen1=0pt
	   \global\leftfulltrue%
	 \fi
	 \ifdim\dimen0<0pt %might cut
	   \ifdim\dimen0>-0.3\baselineskip %Tiny overshoot
	 \advance\dimen1 by \baselineskip %ignore it.
	   \else
	 \TRACEdiglot{Oversized box \the\ht\partialL+\the\dp\partialL, resizing to \the\dimen1, somewhere near \the\inputlineno, \botmark}
	   \fi
	 \fi
   \fi
   %\leftfull is set, so Nastybox won't get touched until the page is output. Therefore use
   % it to tell code below that we've moved everything to the next page.
   \global\nastyboxfalse
   \TempDim=\dimen1
   \advance\TempDim by -\dp\partialL
   \ifdim\TempDim<-0.5\baselineskip% Only split for significant amounts...
	 %Want the first chunk in partialL, the residue in excessL, so vsplit
	 %gets it backwards for us.
	 %Use box0 as a temporary store
	 \ifdim\dimen1>0pt
	   \bgroup
	   \dimen2=\dp\partialL% compare original size...
	   \TRACEdiglot{Splitting to \the\dimen1}
	   \setbox0=\vsplit\partialL to \dimen1%
	   \setbox0=\vtop{\unvbox0}
	   \dimen2=\dimen1%
	   \advance\dimen2 by -\ht\partialL
	   \advance\dimen2 by -\dp\partialL
	   \global\runLtrialtrue%
	   \global\leftfulltrue%
	   \ifdim\dp0=\dimen2 % with the size it is now...
		 \TRACEdiglot{Resize failed. Pushing to next page}
	 \global\nastyboxtrue %Inform diglotRight what's happened
		 \global\setbox\LeftBox=\vbox to \availht{\vfil}%
	 \global\setbox\partialL=\box0
	 \global\runLtrialfalse% Don't add this box
	 \global\availht=0pt
		 \global\nastyboxtrue% Signal to rightbox that the box has moved
	   \else
	 \TempDim=\ht0
	 \advance\TempDim by \dp0
	 \ifdim\TempDim>0pt % It split something off..
	   \TRACEdiglot{spare material to excessL (\the\ht0, \the\dp0, \the\ht\partialL,\the\ht\excessL,\the\dp\partialL,\the\dp\excessL}%
	   %\showbox\excessL%
	   \global\earlyLrefilltrue%
	   \global\setbox\excessL=\vtop{\joinboxes{\partialL}{\excessL}{4}}%
	   \global\setbox\partialL=\box0
	 \else %The whole lot got split off - potential problem
	   \TRACEdiglot{No material remaining after split. Leaving box unchanged and pushing
	   onward (\the\ht0, \the\dp0, \the\ht\partialL,\the\ht\excessL,\the\dp\partialL,\the\dp\excessL}%
	   %\global\setbox\excessL=\vtop{\joinboxes{\partialL}{\excessL}{4}}%
	   \global\setbox\partialL=\vtop{\unvbox\partialL}
	   \global\runLtrialfalse% Don't add this box
	   \global\availht=0pt
	   \global\nastyboxtrue% Signal to rightbox that the box has moved
	 \fi
	   \fi
	   \egroup
	 \else
	   \global\setbox\LeftBox=\vbox to \availht{\vfil}%
	   \global\availht=0pt
	   %\global\setbox\excessL=\vtop{\joinboxes{\partialL}{\excessL}{5}}
	   \global\runLtrialfalse%Don't add this text, leave it in partialL
	   \global\leftfulltrue%
	   \global\nastyboxtrue% Signal to rightbox that the box has moved
	 \fi
   \else
	 \global\runLtrialtrue%
   \fi%
   \egroup
   \ifnum\outputpenalty=-10000
	 %Must relase footnotes, this is end of page.
	 \runLtrialtrue%
	 \global\leftfulltrue%
   \fi%
   \ifnum\outputpenalty=-10001
	 %Must release footnotes, this section of page is about to be committed
	 \runLtrialtrue%
   \fi%
   \ifdim\dp\partialL=0pt
	 %No point in releasing footnotes on an empty chunk
	 \runLtrialfalse%
   \fi%
   \ifdim\availht=0pt
	 %If there's no space (or the box has been postponed), don't add anything
	 \runLtrialfalse%
   \fi%
 \fi%
 \ifrunLtrial %Apply inserts.
   \ifnum\holdinginserts=0
	 \TRACEdiglot{Inserts not held (!?) will not re-run}%
   \else%
	 \global\holdinginserts=0
	 \TRACEdiglot{Re-processing partialL (\the\ht\partialL, \the\availht)}%
	 \global\trialheight=\availht
	 \doDiglotLeftTrial%
   \fi%
 \else
   \ifnastybox %THis box is forcing a page break before itself. Therefore do that pagebreak
	 \TRACEdiglot{Box must start page, forcing page output}
	 \global\nastyboxfalse
	 \global\repeatokfalse
	 \global\setbox\RightBox=\box\voidb@x%
	 \upd@tep@rtial%
   \fi
 \fi%
} %


\def\diglotLeftTrial{%
% Secondary left hand \output routine.
% Should normally get called once per box when that's about to be set. Puts set
% material in LeftBox. If material (e.g. due to footnotes) is too big,
% shrink vsize and try again.
  \TRACEdiglot{diglotLeftTrial, \the\holdinginserts, \the\outputpenalty,
  \the\deadcycles, LB:\the\ht\LeftBox+\the\dp\LeftBox, av:\the\availht, vs:\the\vsize,
  pg:\the\pagegoal}%
 \makevtop{255}%
 \global\setbox\LeftBox=\box255
  %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeftTrial:}\copy\LeftBox}}%
  \TRACEdiglot{Box=\the\ht\LeftBox+\the\dp\LeftBox}%
  \global\deadcycles=0
  \global\holdinginserts=1 % inserts inactive again
  \ifleftfull%
  \else%
	%Footnotes may have been added that fill up the available space even if
	%it wasn't full before.
	\calc@vailht%
	\advance\availht by -\the\ht\LeftBox %
	\advance\availht by -\the\dp\LeftBox %
	\TRACEdiglot{av: \the\availht bs:\the\baselineskip}
	\ifdim\availht<\baselineskip %
	  \TRACEdiglot{Footnotes make left column full}%
	  \global\leftfulltrue%
	\fi%
  \fi%
  \ifnum\outputpenalty=-10005 %
	\TRACEdiglot{Final penalty found}%
	\outputpenalty=0 %
	\n@xtc@mmand%
	\global\def\n@xtc@mmand{}%
	\ifdigl@tL%
	  \global\output={\diglotLeft}\relax%
	\else%
	  \global\output={\diglotRight}%
	  \global\diglotLfalse
	  \global\hsize=\columnRwidth
	  \calc@vailht
	  \global\vsize=\availhtR
	\fi%
  \else%
	\TRACEdiglot{Other penalty found}%
	\ifnum\lastsavedLpenalty=10000\relax%
	  \ifnum\outputpenalty=10000\relax%
		\global\lastsavedLpenalty=0 %
	   \else%
		 \global\lastsavedLpenalty=\outputpenalty%
	   \fi%
	\fi%
	\let\do@nce=\n@xtc@mmand %
	\global\def\n@xtc@mmand{} %
	\do@nce%
	\global\output={\diglotLeftAfterTrial}\relax%
	\relax%
  \fi%
}

\newbox\aftertri@lbox
\def\diglotLeftAfterTrial{%
  \TRACEdiglot{diglotLeftAfterTrial \the\outputpenalty, \the\deadcycles,
   av:\the\availht, vs:\the\vsize, pg:\the\pagegoal, pt:\the\pagetotal}%
 \makevtop{255}
  \ifvoid\aftertri@lbox%
	\global\setbox\aftertri@lbox=\box255 %
  \else%
	\global\setbox\aftertri@lbox=\vtop{\joinboxes{\aftertri@lbox}{255}{6}}\relax%
  \fi
  \TRACEdiglot{\the\ht\aftertri@lbox}%
  %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeftAfterTrial:}\copy\aftertri@lbox}}%
  \ifnum\outputpenalty=-10005\relax%
	\global\setbox\partialL=\vtop{\joinboxes{\aftertri@lbox}{\partialL}{7}}%Add stuff back to partialL
	%\showbox\partialL
	\ifdigl@tL%
	  \global\output={\diglotLeft}\relax%
	\else%
	  \global\output={\diglotRight}\relax%
	  \global\diglotRtrue
	  \calc@vailht
	\fi%
	 \n@xtc@mmand%
	 \global\def\n@xtc@mmand{}%
  \fi
}

\def\doDiglotLeftTrial{%
  \TRACEdiglot{doDiglotLeftTrial LB:\the\ht\LeftBox+\the\dp\LeftBox, pL:(\the\ht\partialL+\the\dp\partialL)}%
  \ifdiglotL%Save current state
	\global\digl@tLtrue%
  \else%
	\global\digl@tLfalse%
	\global\diglotLtrue%
	\global\hsize=\columnLwidth\relax%
  \fi%
  \calc@vailht%
  \TRACEdiglot{av: \the\availht, tr: \the\trialheight}%
  \global\output={\diglotLeftTrial}\relax%
  \global\vsize=\trialheight\relax%
  \global\holdinginserts=0 %
  \bgroup\joinboxes{\LeftBox}{\partialL}{10}\par\penalty-10005\egroup\relax{\aftergroup\relax}%
}

% Initial \output routine for right scripture
\def\diglotRight{%
 %Assumptions: Called by output routine.
 %Fills: partialR
 %Empties 255
 %Sets thisboxpenalty and some provisional page marking
 \ifnum\outputpenalty=10000\relax% Nothing wrong with breaking here
   \thisboxpenalty=0
 \else
   \ifnum\outputpenalty=-10001\relax%Got to the end of the \lefttext
	 \thisboxpenalty=\savedpenalty
   \fi
 \fi
 % put following material into partialR
 \TRACEdiglot{diglotRight \the\outputpenalty}
 \edef\t@st{\botmark}%
 \ifx\t@st\empty\else
 \TRACEdiglot{Setting (default) bottom mark to \botmark, may revise later}%
 \xdef\b@xbotmark{\botmark}\fi%
 \edef\t@st{\p@gefirstmark}%
 \ifx\t@st\empty\xdef\p@gefirstmark{\firstmark}\fi % remember first, if not already set
 \hsize=\columnRwidth\relax%
 \makevtop{255}
 \ifvoid\partialR%
   \global\setbox\partialR=\vtop{\unvbox255}
 \else%
   \global\setbox\partialR=\vtop{\joinboxes{\partialR}{255}{11}}\relax%
 \fi%
 \ifnum\thisboxpenalty=0\relax\else%restore any penalty that might have been just before the column swap
   \global\setbox\partialR=\vtop{\unvbox\partialR}
 \fi
 %\showbox\partialR
 \setboth%
} %
%
\newcount\savedpenalty%
\newcount\lastsavedLpenalty%
\newcount\lastsavedRpenalty%
%
% Change which side we're adding to
\def\lefttext{%
  \TRACEdiglot{lefttext}%
  \global\savedpenalty=\lastpenalty\relax%
  \calc@vailht%
  \n@xtc@mmand%
  \par\penalty-10001%
  \relax%
  \global\digl@tLtrue%
  \global\diglotLtrue%
  \ifleftfull % Already full, just swallow text...
	\global\vsize=\textheight
	\global\availht=\vsize
  \else
	\calc@vailht%Recalculate for this column
	\global\vsize=\availht\relax%
  \fi
  %Other Left parameters
  \output={\diglotLeft}\relax%
  \swapfonts{L}%
  \global\hsize=\columnLwidth}\relax%
%
\def\righttext{\TRACEdiglot{righttext}\global\savedpenalty=\lastpenalty\n@xtc@mmand\holdinginserts=1\par\penalty-10001\relax\global\digl@tLfalse\global\diglotRtrue\calc@vailht\global\vsize=\availht\relax\output={\diglotRight}\swapfonts{R}\global\hsize=\columnRwidth\relax}%
%
% When there's a header on the left but not the right, but we want the verses
% to line up nicely...
\def\norighttext{\savedpenalty=\lastpenalty\relax\global\TRACEdiglot{norighttext}\par\penalty-10001\relax\global\diglotLtrue\global\digl@tLtrue\thisboxpenalty=0\relax\setboth\output={\diglotLeft}\global\hsize=\columnLwidth\relax}%

%Similarly when there's no left text, copying \righttext seems OK ...
\def\nolefttext{\TRACEdiglot{nolefttext}\global\savedpenalty=\lastpenalty\n@xtc@mmand\holdinginserts=1\par\penalty-10001\relax\global\digl@tLfalse\global\diglotRtrue\calc@vailht\global\vsize=\availht\output={\diglotRight}\swapfonts{R}\global\hsize=\columnRwidth\relax}%

\newdimen\columnLwidth%
\newdimen\columnRwidth%
\newdimen\availhtL
\newdimen\availhtR
\newdimen\pr@vdepth
\newif\ifdiglotL%
\newif\ifdigl@tL%
\let\diglotRtrue=\diglotLfalse\relax%
\def\swapfonts#1{% Because it might be desirable to set fonts appropriately.
%Swapping fonts isn't actually needed, but do need to set
%baselineskip
\TRACEdiglot{swapfonts #1}
\def\@@setside{\global\csname diglot#1true\endcsname}%
\@@setside%
\TRACEdiglot{Leadingunit: \the\le@dingunit}
\ifdim\le@dingunit>0pt %
  \s@tbaseline{p}%
\fi
\ifdim\baselineskip=0pt
  \message{baseline set to 0pt EEK}
  \global\baselineskip=12pt
\fi
}



%\output={\diglotLeft}
%\hsize=\columnLwidth
\newif\ifleftfull % Is the left column full?
\newif\ifpagefull % Is the page full?
\newdimen\Lht
\newdimen\Rht %
\newdimen\TempDim %
\newbox\LeftBox % The part of partialL which fits on the page
\newbox\RightBox % The part of partialR which fits on the page

%when there's no more input, make sure partial gets printed
\def\emitpartial{%
	\@writep@ge\@writep@ge%
	\global\leftfullfalse%
	\global\pagefullfalse%
}
\newif\ifrepeatpermitted  %Not to be confused by repeatok which is set by caller
\newif\ifredocolok%
\def\setboth{%
  %Assumptions:
  %\LeftBox has been filled by diglotLeftTrial.
  %\partialL may have extra material in it, which hasn't been footnoted.
  %\RightBox needs to be filled from partialR.
  %\thisboxpenalty correctly (about partialR) set by caller
  \TRACEdiglot{setboth \the\outputpenalty, \the\savedpenalty}%
  \calc@vailht
  \global\splittopskip=\baselineskip
  \global\topskip=\baselineskip
  \global\Lht=\ht\LeftBox\relax%
  \advance\Lht by \dp\LeftBox
  \global\Rht=\ht\partialR\relax%
  \advance\Rht by \dp\partialR
  % Force page output if user-caused and not by a column swap.
  \redocoloktrue%
  \pagefullfalse%
  \repeatpermittedfalse% in most situations we don't want this looping.
  \ifnum\outputpenalty=-10000
   \pagefulltrue%
  \fi%
  \ifnum\outputpenalty=-10002 %Set on self-repeat calls
   \pagefullfalse%
   \redocoloktrue%
  \fi%
  \ifnum\outputpenalty=-10001 %
   \pagefullfalse%
   \redocolokfalse%
   \repeatpermittedtrue%
  \fi%
  \ifnum\outputpenalty=-10005 %
   \repeatpermittedtrue%
  \fi%
  \ifnum\savedpenalty = 10000 %Box is probably a title or similar - never OK to refill here
	\redocolokfalse%
  \fi%
  % Don't allow unvboxing the right column if we're in left column mode«É
  \ifdiglotL%
	\redocolokfalse%
  \fi%
  \ifdigl@tL%
	\redocolokfalse%
  \fi%
  % Eject a partial page when we're done too, in some cases
  \ifnum\outputpenalty=-20000 % End of document / supereject
   \pagefulltrue%
   \redocolokfalse%
   \aftergroup\emitpartial%
  \fi%
  \edef\nextp@gefirstmark{}%
  \ifnum\thisboxpenalty=10000\relax% Can't break here
	\TRACEdiglot{Checking what to do with this box (\the\ht\partialR+\the\dp\partialR)}
	\checkn@sty{\availhtR}{\Rht}
	\ifdim\TempDim<\Rht %split required
	  \availht=\TempDim\relax% Save the cutting length
	\else
	  \TRACEdiglot{No split required}
	\fi%
  \fi%
  \TempDim=\availht\relax%
  \ifnastybox% All the last left box was shifted to the next page. Since the first line of l+r
	%boxes should line up then the right box should be passed on too
	\TRACEdiglot{Box should move}
	\global\pagefulltrue%
	\global\TempDim=-10pt %SPACE is critical!
  \else%
  \fi%
  \global\nastyboxfalse %unset it
  %\TRACEdiglot{\the\TempDim}
  \ifdim\TempDim<0pt %
	%\TRACEdiglot{SKIP2}
	\ifdim\availht<0pt %
	  %Need to drop something. Picture or text, I don't know
	  %FIXME This shouldn't happen...
	  \message{Out of space: av = \the\availht, th=\the\textheight,
	  tr=\the\trialheight, part=(\the\ht\partial+\the\dp\partial)}%
	\fi
	%Leave partialR untouched - out of space anyway.
	\TRACEdiglot{Leaving R box for next page}
	\global\setbox\RightBox=\box\voidb@x%
	\pagefulltrue%
  \else%
	%pagefulltrue should be set if the left column can't hold more too.
	\ifleftfull
	  \pagefulltrue
	\fi
	%Not sure this is needed, but it shouldn't hurt
	\TempDim=\availhtL
	\advance\TempDim by -\Lht
	\ifdim\TempDim<\baselineskip%
	  \pagefulltrue%
	\fi%
	%\ifdim\ht\partialL>0pt %
	  %\TRACEdiglot{partialL not empty. Not setting extra \the\ht\partialL of material this time}%
	%\fi%
	\ifvoid\partialL
	  \TRACEdiglot{Refilling partialL from excessL}
	  \global\setbox\partialL=\vtop{\unvbox\excessL}%
	\else
	  \ifvoid\excessL\else
	\TRACEdiglot{Refilling partialL from excessL}
		\global\setbox\partialL=\vtop{\joinboxes{\partialL}{\excessL}{9}}%
	  \fi
	  %\showbox\partialL
	\fi
	\TempDim=\availht
	\advance\TempDim by -\Rht
	\ifdim\TempDim<-0.3\baselineskip % Allow a little extra for descenders
	  \message{Splitting right to \the\availht}%
	  \global\setbox\RightBox=\vsplit\partialR to \availht
	  {\setbox 0=\copy\partialR%
	  \setbox 1=\vsplit 0 to \ht\partialR%
	  \gdef\nextp@gefirstmark{\splitfirstmark}}%
	  \edef\t@st{\splitbotmark}%
	  \ifx\t@st\empty\else
		\TRACEdiglot{Setting bottom mark to \splitbotmark}
		\xdef\p@gebotmark{\splitbotmark}%
	  \fi
	  \makevtop{\partialR}%
	  \global\Rht=\ht\RightBox\relax%
	  \pagefulltrue%
	\else% It all fits...
	  \global\setbox\RightBox=\box\partialR%
	  \edef\t@st{\b@xbotmark}%
	  \ifx\t@st\empty
		\TRACEdiglot{Setting bottom mark to - as emergency measure}%
		\xdef\p@gebotmark{-}%
	  \else%
		\TRACEdiglot{Setting bottom mark to \b@xbotmark, may revise later}%
		\xdef\p@gebotmark{\b@xbotmark}%
	  \fi%
	\fi%
	%pagefulltrue should be set if the page can't hold more too.
	\TempDim=\availht
	\advance\TempDim by -\Rht
	\ifdim\TempDim<\baselineskip%
	  \pagefulltrue%
	\fi%
  \fi%
  \message{av:\the\availht}%
  \message{L:\the\ht\LeftBox+\the\dp\LeftBox}%
  \message{R:\the\ht\RightBox+\the\dp\RightBox}%
  \TempDim=\ht\RightBox\relax%
  \advance\TempDim by -\ht\LeftBox
  \advance\TempDim by \dp\RightBox
  \advance\TempDim by -\dp\LeftBox
  %\message{TempDim is \the\TempDim}
  \ifdim \TempDim>0pt %Right box is longest
	\dimen0=\dp\LeftBox\relax%
	\advance\TempDim by -\dp\LeftBox
	\global\setbox\LeftBox=\vtop{\unvbox\LeftBox}%
  \fi%
  \ifdim \TempDim<0pt %Left box is longest
	\advance\TempDim by \dp\RightBox
	\dimen0=\dp\RightBox\relax%
	\ifredocolok%
	  \ifpagefull%
		\global\setbox\RightBox=\vtop{\unvbox\RightBox}%
		\upd@tep@rtial%
	  \else %pagefull
	\ifnum\deadcycles<15 %
	  %We can safely have a go at re-setting this column.
	  \message{Trying to refill right column}%
	  %\global\setbox\partialL=\vbox{\unvbox\LeftBox\unvbox\partialL}
	  \unvbox\RightBox%
	  \ifnum\outputpenalty = 10000
		\penalty 10
	  \else %
		\ifnum\outputpenalty<-100
		  \penalty 999
		\else%
		  \penalty\outputpenalty%
		\fi%
	  \fi %outputpenalty
	\else %deadcycles. Set partial with partly empty page
	  \global\setbox\RightBox=\vtop{\unvbox\RightBox}%
	  \upd@tep@rtial%
	\fi%
	  \fi %pagefull
	\else %redocolok
	  \global\setbox\RightBox=\vtop{\unvbox\RightBox}%
	  \upd@tep@rtial%
	\fi %redocolok
  \else %TempDim
	\global\setbox\RightBox=\vtop{\unvbox\RightBox}%
	\upd@tep@rtial%
  \fi %TempDim
}
\def\checkn@sty#1#2{%
  %Parameters availht, boxheight
  %If Box needs moving to next page or splitting, sets ifnastybox and \TempDim
  %Sets \TempDim to #2 if no change needed.
  \TempDim=#1\advance\TempDim by -#2
  \ifdim\TempDim>-0.3\baselineskip% Box would fit
	\ifdim\TempDim<2\baselineskip% But it only just fits - hardly even another line after it
	  \ifdim#2>3\baselineskip% It can be split though
		\global\TempDim=#1\relax%
	\global\advance\TempDim by -2\baselineskip
		\global\nastyboxtrue%
	  \else%Can't split it and can't fit anything after it. Pass it on to next page
		\global\TempDim=0pt %
	\global\nastyboxtrue%
	  \fi%
	\else%
	  \global\TempDim=#2\relax%No change needed
	\fi%only just fits
  \else% Doesn't fit anyway
	\ifdim#2>3\baselineskip% It can be split though
	  \global\TempDim=#2\relax%
	  \global\advance\TempDim by -\baselineskip
	  \global\nastyboxtrue%
	\else %Can't split it and it doesn't fit %
	  \global\TempDim=0pt %
	  \global\nastyboxtrue%
	\fi%
  \fi%
}
\def\makevtop#1{%There is a strong posibility that a vbox has a depth that
%is unrecoverable on changing it to a vtop, e.g. if the last item in the
%vbox is a \mark. To rejoin boxes on a page accurately we need to preserve
%the depth of the box. We therefore assume the box will be joined and if
%the depth is not recoverable we add a kern to remove the orignial depth.
 \TRACEdiglot{makevtop #1, before vtop dp=\the\dp#1}%
 \pr@vdepth=\dp#1\relax%
 \setbox#1=\vtop{\bgroup\unvbox#1\setbox1=\lastbox\dimen0=\dp1\box1\TRACEdiglot{pd:\the\dimen0, @d:\the\pr@vdepth}\ifdim\dimen0=0pt\ifdim\pr@vdepth=0pt\else\kern-\pr@vdepth\fi\fi\egroup}}%
\def\joinboxes#1#2#3{%Join 2 vtops together and preserve baselineskip%
%\showbox#1\showbox#2%
\TRACEdiglot{joinboxes #1 #2 called from locn #3}
\bgroup
%\ifnum#3=10\showbox#1\fi%
\ifvoid#1\else%
\unvbox#1%
%\showlists
\setbox0=\lastbox
\copy0
\TRACEdiglot{deconstructed box \the\ht0+\the\dp0}
\ifdim\dp0<\baselineskip
\kern -\dp0
\else
\showbox0
\fi
\ifnum#3=99\hrule\kern -0.4pt\fi% Test code
\fi%
\ifvoid#2\else%
\unvbox#2%
\fi%
\egroup}

\def\joinb@xes#1#2{%Join a vtop and an hbox together and preserve baselineskip%
%\showbox#1\showbox#2%
\bgroup\dimen0=\baselineskip\advance\dimen0 by -\ht#1\unvbox#1\setbox0=\lastbox\box0
\ifdim\dp0<\baselineskip\advance\dimen0 by -\dp0\fi
%\ifdim\dimen0<0pt\dimen0=0pt\fi%
%\vglue\dimen0
\box#2\egroup}


\def\upd@tep@rtial{%
  \TRACEdiglot{upd@tep@rtial}%
  \showboxdepth=3 %
  \showboxbreadth=1000 %
  %\ifnum\pageno=10%
  %\showbox\LeftBox%
  %\showbox\RightBox%
  %\fi%
  \global\def\n@xtc@mmand{}%
  \message{|}%
  \hsize=\textwidth%
  \edef\t@st{\p@gebotmark}%
  \ifx\t@st\empty
	\TRACEdiglot{Setting bottom mark to \b@xbotmark, since it's empty }%
	\xdef\p@gebotmark{\b@xbotmark}%
  \fi
  %Re-use LeftBox for this page chunk
  \TRACEdiglot{Adding to page: LB:\the\ht\LeftBox+\the\dp\LeftBox RB:\the\ht\RightBox+\the\dp\RightBox}
  \global\setbox\LeftBox=\vtop{\hbox to \textwidth{%\llap{\the\ht\LeftBox \the\dp\LeftBox}
  \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
  \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
  }}%
  \TRACEdiglot{adding box to partial (\the\ht\LeftBox)}%
  \global\setbox\partial=\vtop{\joinb@xes{\partial}{\LeftBox}}
  \ifleftfull % This box fills the left column (with footnotes)
	\pagefulltrue
  \fi
  \calc@vailht
  \ifdim\availht<\baselineskip %
	\pagefulltrue%
  \else%
	\global\trialheight=\availht\relax%
	\global\vsize=\availht\relax%
  \fi%
  \deadcycles=0 %
  \global\lastsavedLpenalty=\savedpenalty % Remember how happy we are to break at this point
  \ifpagefull%
	\@writep@ge%
	\global\setbox\RightBox=\box\voidb@x%
  \fi%
  \ifpagefull % Page was written
	\global\leftfullfalse%
	\global\pagefullfalse%
	\global\holdinginserts=1 %

	\global\availht=\textheight %
	\global\vsize=\availht\relax%
	\ifearlyLrefill%
	  %There is material in excessL which should be added now, not later.
	  \TRACEdiglot{Refilling partialL early}%
	  \global\setbox\partialL=\vtop{\joinboxes{\partialL}{\excessL}{12}}%
	  \global\earlyLrefillfalse%
	\fi
	\TRACEdiglot{pL:(\the\ht\partialL+\the\dp\partialL) pR:(\the\ht\partialR+\the\dp\partialR)}%
	\ifdim\dp\partialL>0pt %
	  %Assumptions: Page is empty, LeftBox is empty, partialL contains extra
	  %material for left column, excessL is empty (from setboth).
	  \ifrepeatpermitted%
		% Quite possibly have enough material already - repeat 'til not a full page.
	\ifdim\dp\partialR>0pt %
		  %There is something to add to the RHS.. After re-setting partialL, setboth should be called.
		  \message{Repeating setboth}%
		  \global\def\n@xtc@mmand{\TRACEdiglot{n@xtc@mmand}\setboth}%
		\else
	  \ifrepeatok
		%Right is empty, left has something. Don't call setboth, come straight back to updatepartial
			\message{Repeating upd@tep@rtial}%
			\global\def\n@xtc@mmand{\TRACEdiglot{n@xtc@mmand}\upd@tep@rtial}%
	  \else
		% Don't repeat - e.g. when called here from \diglotLeft ??? Or only sometimes?
			\message{Not Repeating upd@tep@rtial}%
		\global\repeatoktrue
	  \fi
	\fi
	  \fi%
	  \ifdim\dp\partialL>\availht%
		%Want the first chunk in partialL, the residue in excessL, so vsplit
		%gets it backwards for us.
		%Use LeftBox as a temporary store
	\TRACEdiglot{Spliting \the\ht\partialL to \the\availht}
		\setbox\LeftBox=\vsplit\partialL to \availht%
	\makevtop{\partialL}%
	\makevtop{\LeftBox}%
		\global\setbox\excessL=\box\partialL\relax%
	\global\setbox\partialL=\box\LeftBox\relax%
	  \else%
		\global\outputpenalty=-10002\relax%No more itterations after this
		\global\setbox\partialL=\vtop{\unvbox\partialL}%
	  \fi%
	  \global\trialheight=\availht\relax%
	  \doDiglotLeftTrial%
	\else %\ft\partialL
	  \ifnum\outputpenalty=-10001\relax%
		% No partialL mtl, but possibly have right column that should be
	% set.
		\message{Repeating setboth}%
		\setboth%
	  \fi %outputpenalty%
	\fi %\ht\partiaL
  \fi%
}

\newif\ifLRf@@tnotes%
\newif\ifs@vedL%
\def\@writep@ge {%
  \TRACEdiglot{@writep@ge}%
  \global\setbox\galley=\vbox{\unvbox\partial}%
  \ifdiglotSepNotes%
	\TRACEdiglot{Sep notes}%
	\s@vedLfalse%
	\ifdiglotL%
	  \s@vedLtrue%
	\fi%
	\LRf@@tnotesfalse%
	\f@rstnotetrue%
	\diglotLtrue%
	\dimen0=0pt %
	%Arrange Left and Right footnotes
	\global\setbox\LeftBox=\vbox{\let\\=\ins@rtn@tecl@ss \the\n@tecl@sses}%
	\iff@rstnote%
	  \TRACEdiglot{No Left footnotes}%
	\else%
	  \LRf@@tnotestrue%
	  \f@rstnotetrue%
	\fi%
	\dimen0=0pt %
	\diglotLfalse%
	\global\setbox\RightBox=\vbox{\let\\=\ins@rtn@tecl@ss \the\n@tecl@sses}%
	\iff@rstnote%
	  \TRACEdiglot{No Right footnotes}%
	\else%
	  \LRf@@tnotestrue%
	\fi%
	\diglotLfalse%
	\ifs@vedL%
	  \diglotLtrue%
	\fi%
	\ifdiglotBalNotes%
	  \TRACEdiglot{Balanced notes}%
	  \ifLRf@@tnotes%
	\kern\dimen0%
		\TRACEdiglot{Footnotes}%
	\ifdim\ht\LeftBox>\ht\RightBox%
	  \setbox\RightBox=\vbox to \ht\LeftBox{\box\RightBox\vss}%
	\else%
	  \setbox\LeftBox=\vbox to \ht\RightBox{\box\LeftBox\vss}%
	\fi%
		\setbox\LeftBox=\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
		  \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
		  \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
		}%
		\setbox\galley=\vbox{\unvbox\galley\box\LeftBox}%
	  \else%
		\TRACEdiglot{No footnotes}%
	  \fi %LRf@@tnotes
	\else %BalNotes
	  \TRACEdiglot{unBalanced notes}%
	  \ifLRf@@tnotes%
	%Lht and Rht hold the height of the last boxes added to the page
	%Need to find out where to put the footnotes, as one of them should
	%be close to its respective text.
	{\dimen1=\Lht
	\advance\dimen1 by -\Rht % dimen1 is step in text
	\dimen2=\ht\LeftBox\relax%
	\TRACEdiglot{L:\the\Lht R:\the\Rht lf:(\the\ht\LeftBox+\the\dp\LeftBox) rf:(\the\ht\RightBox+\the\dp\RightBox)}
	\advance\dimen2 by -\ht\RightBox % dimen2 is step in footnotes
	%
		\setbox\LeftBox\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
		  \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
		  \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
		}%
	\advance\dimen2 by -\ht\RightBox % dimen2 is step in footnotes
	%
		\setbox\LeftBox\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
		  \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
		  \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
		}%

	\ifdim\dimen1<0pt %dimen1 -ve
	  \ifdim\dimen2<0pt %dimen2 -ve
		  \dimen3=0pt %No adjustment
	  \else  %dimen2 +ve
		\ifdim\dimen1 > -\dimen2
		  \dimen3=-\dimen1
		\else%
		  \dimen3=\dimen2
		\fi%
	  \fi  %dimen2 %dimen2 -ve
	\else %dimen1 +ve
	  \ifdim\dimen2<0pt %
		\ifdim\dimen1 > -\dimen2
		  \dimen3=-\dimen2
		\else%
		  \dimen3=\dimen1
		\fi%
	  \else %dimen2 +ve
		\dimen3=0pt %No adjustment
	  \fi%
	\fi%
		\TRACEdiglot{Adjusting footnotebox}%
	\global\setbox\galley=\vbox{\unvbox\galley\kern -\dimen3\box\LeftBox}%
	}%
	  \else%
		\TRACEdiglot{No footnotes}%
	  \fi%
	\fi %BalNotes
  \else %SepNotes
	\TRACEdiglot{Merged notes}%
  \fi%
  %\fi
  %\TRACEdiglot{LOST1}
  %\fi
  %\TRACEdiglot{LOST2}
  \TRACEdiglot{Forming page}%
  %\showbox\galley
  %\showthe\everyhbox
  %\showthe\leftskip
  %\showthe\rightskip
  \def\pagecontents{%
   \ifvoid\topins\else \unvbox\topins \vskip\skip\topins \fi%
   \dimen0=\dp\galley\relax%
   \unvbox\galley%
   \ifvoid\bottomins\else\kern-\dimen0 \dimen0=0pt \vskip\skip\bottomins \unvbox\bottomins \fi%
   \vbox to 0pt{}%
   \ifdiglotSepNotes%
   \else%
	 \TRACEdiglot{Inserting Notes}%
	 \f@rstnotetrue%
	 \let\\=\ins@rtn@tecl@ss \the\n@tecl@sses%
   \fi%
   \iff@rstnote % no notes actually occurred!
	 \kern-\dimen0 \vfil%
   \else%
	 \setbox0=\lastbox \dimen0=\dp0 \box0 \kern-\dimen0
   \fi%
  }%
  \TRACEdiglot{PFM:\p@gefirstmark PBM:\p@gebotmark}
  \resetvsize%
  \plainoutput
  \xdef\p@gefirstmark{\nextp@gefirstmark}%
  \xdef\nextp@gefirstmark{}%
  \xdef\p@gebotmark{}%
  \global\setbox\RightBox=\box\voidb@x%
  \global\setbox\LeftBox=\box\voidb@x%

}


%
%
\endinput
